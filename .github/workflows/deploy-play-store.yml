---
# Workflow de dÃ©ploiement automatique vers Google Play Store
# DÃ©ploie automatiquement sur la branche main vers les tests internes

name: Deploy to Play Store (Internal Testing)

on:
  push:
    branches: [main]
    tags:
      - "v*"
  workflow_dispatch: # Permet de dÃ©clencher manuellement

env:
  FLUTTER_VERSION: "3.35.3"
  PACKAGE_NAME: "com.arkalia.cia"
  TRACK: "internal" # internal, alpha, beta, production

jobs:
  deploy:
    name: Build and Deploy to Play Store
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: "stable"
          cache: true

      - name: Get Flutter dependencies
        working-directory: arkalia_cia
        run: flutter pub get

      - name: Verify Flutter setup
        working-directory: arkalia_cia
        run: flutter doctor -v

      - name: Phase 1 - Configure flutter.source
        working-directory: arkalia_cia
        run: |
          chmod +x scripts/ci-phase1-configure-flutter-source.sh
          ./scripts/ci-phase1-configure-flutter-source.sh

      - name: Check signing keys availability
        id: check-signing
        run: |
          if [ -n "${{ secrets.KEYSTORE_BASE64 }}" ] && [ -n "${{ secrets.KEYSTORE_PASSWORD }}" ] && [ -n "${{ secrets.KEY_PASSWORD }}" ]; then
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "available=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup signing keys
        working-directory: arkalia_cia/android
        if: steps.check-signing.outputs.available == 'true'
        run: |
          echo "ðŸ” Setting up signing keys..."
          # DÃ©coder le keystore depuis base64
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > \
            app/arkalia-cia-release.jks

          # CrÃ©er le fichier key.properties
          KEY_ALIAS_VALUE="${{ secrets.KEY_ALIAS }}"
          if [ -z "$KEY_ALIAS_VALUE" ]; then
            KEY_ALIAS_VALUE="arkalia-cia"
          fi
          cat > key.properties << EOF
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=$KEY_ALIAS_VALUE
          storeFile=app/arkalia-cia-release.jks
          EOF

          echo "âœ… Signing keys configured"

      - name: Clean Flutter build
        working-directory: arkalia_cia
        run: |
          echo "ðŸ§¹ Cleaning previous builds..."
          flutter clean
          echo "âœ… Clean completed"

      - name: Build App Bundle
        working-directory: arkalia_cia
        env:
          GRADLE_OPTS: "-Dorg.gradle.daemon=false"
        run: |
          echo "ðŸ”¨ Building App Bundle..."
          flutter build appbundle --release
          echo "âœ… Build completed"

      - name: Verify App Bundle exists
        working-directory: arkalia_cia
        run: |
          BUNDLE_PATH="build/app/outputs/bundle/release/app-release.aab"
          if [ ! -f "$BUNDLE_PATH" ]; then
            echo "âŒ Error: App Bundle not found!"
            exit 1
          fi
          echo "âœ… App Bundle found:"
          ls -lh "$BUNDLE_PATH"

      - name: Verify App Bundle signature
        working-directory: arkalia_cia
        if: always()
        run: |
          BUNDLE_PATH="build/app/outputs/bundle/release/app-release.aab"
          if [ -f "$BUNDLE_PATH" ]; then
            echo "ðŸ” Verifying App Bundle signature..."
            if jarsigner -verify -verbose -certs "$BUNDLE_PATH" \
              > /dev/null 2>&1; then
              echo "âœ… App Bundle is properly signed"
            else
              echo "âš ï¸ App Bundle signature verification failed" \
                "(may be signed with debug key)"
            fi
          fi

      - name: Check if service account exists
        id: check-secret
        run: |
          if [ -n "${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload to Play Store
        if: steps.check-secret.outputs.exists == 'true'
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: \
            ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: ${{ env.PACKAGE_NAME }}
          releaseFiles: >-
            arkalia_cia/build/app/outputs/bundle/release/app-release.aab
          track: ${{ env.TRACK }}
          status: completed
          changesNotSentForReview: false

      - name: Upload artifact (fallback if no service account)
        if: steps.check-secret.outputs.exists == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: arkalia_cia/build/app/outputs/bundle/release/app-release.aab
          retention-days: 7

      - name: Deployment summary
        if: always()
        run: |
          echo "## ðŸ“¦ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package**: ${{ env.PACKAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Track**: ${{ env.TRACK }}" >> $GITHUB_STEP_SUMMARY
          echo "**Flutter Version**: ${{ env.FLUTTER_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-signing.outputs.available }}" == "true" ]; then
            echo "âœ… **Signing**: Release keystore configured" \
              >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Signing**: Using debug key" \
              "(not suitable for Play Store)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**âš ï¸ Action required**: Configure KEYSTORE_BASE64," \
              "KEYSTORE_PASSWORD, KEY_PASSWORD secrets" \
              >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-secret.outputs.exists }}" == "true" ]; then
            echo "âœ… **Status**: Deployed to Play Store" \
              >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Status**: App Bundle built" \
              "(manual upload required)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Next steps**: Upload the artifact manually" \
              "to Play Console" >> $GITHUB_STEP_SUMMARY
          fi

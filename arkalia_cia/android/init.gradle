// Force Gradle to use the correct user home directory
// Version: 3.1 - Ultra-robust with comprehensive error handling and code optimization
// This script prevents Gradle from using /Volumes/T7/gradle

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================

/**
 * Comprehensive function to get user home - handles all edge cases
 * Priority order: HOME env -> USER_HOME env -> user.home property -> /Users/USER -> /Users/athalia
 */
def getUserHome() {
    def home = null
    
    // Priority 1: Environment variable HOME (most reliable)
    home = System.getenv("HOME")
    if (home != null && !home.isEmpty() && !home.startsWith("/Volumes/") && new File(home).exists()) {
        return home
    }
    
    // Priority 2: Environment variable USER_HOME
    home = System.getenv("USER_HOME")
    if (home != null && !home.isEmpty() && !home.startsWith("/Volumes/") && new File(home).exists()) {
        return home
    }
    
    // Priority 3: System property user.home
    home = System.getProperty("user.home")
    if (home != null && !home.isEmpty() && !home.startsWith("/Volumes/") && new File(home).exists()) {
        return home
    }
    
    // Priority 4: Construct from USER environment variable
    def user = System.getenv("USER")
    if (user != null && !user.isEmpty()) {
        home = "/Users/${user}"
        if (new File(home).exists()) {
            return home
        }
    }
    
    // Priority 5: Fallback to explicit username
    home = "/Users/athalia"
    if (new File(home).exists()) {
        return home
    }
    
    // Last resort: Use system property even if on volume (better than nothing)
    return System.getProperty("user.home") ?: System.getenv("HOME") ?: "/Users/athalia"
}

/**
 * Get fallback home directory based on USER environment variable
 */
def getFallbackHome() {
    def user = System.getenv("USER")
    return "/Users/${user ?: "athalia"}"
}

/**
 * Ensure .gradle directory exists and is writable
 */
def ensureGradleHome(gradleHome) {
    if (gradleHome == null) {
        return false
    }
    
    if (!gradleHome.exists()) {
        try {
            gradleHome.mkdirs()
            println "✅ Init.gradle: Created directory: ${gradleHome.absolutePath}"
        } catch (Exception e) {
            println "⚠️  Init.gradle: Could not create ${gradleHome.absolutePath}: ${e.message}"
            return false
        }
    }
    
    // Verify it's writable
    if (!gradleHome.canWrite()) {
        println "⚠️  Init.gradle: Warning - ${gradleHome.absolutePath} is not writable"
        return false
    }
    
    return true
}

/**
 * Set Gradle user home properties and ensure directory exists
 */
def setGradleUserHome(gradleHome) {
    if (gradleHome == null) {
        return false
    }
    
    try {
        System.setProperty("org.gradle.user.home", gradleHome.absolutePath)
        System.setProperty("gradle.user.home", gradleHome.absolutePath)
        ensureGradleHome(gradleHome)
        return true
    } catch (Exception e) {
        println "⚠️  Init.gradle: Error setting gradle home: ${e.message}"
        return false
    }
}

/**
 * Validate that a path is safe (not on volume, parent exists)
 */
def isPathSafe(file) {
    if (file == null) {
        return false
    }
    def parent = file.parentFile
    return parent != null && parent.exists() && !parent.absolutePath.startsWith("/Volumes/")
}

/**
 * Force Gradle user home with fallback mechanism
 */
def forceGradleUserHome(settings, gradleHome, context) {
    if (isPathSafe(gradleHome)) {
        try {
            if (settings != null) {
                settings.gradle.gradleUserHomeDir = gradleHome
            }
            setGradleUserHome(gradleHome)
            println "✅ Init.gradle (${context}): Gradle user home forced to: ${gradleHome.absolutePath}"
            return true
        } catch (Exception e) {
            println "⚠️  Init.gradle (${context}): Error setting gradle home: ${e.message}"
        }
    }
    
    // Use fallback
    def fallback = new File(getFallbackHome(), ".gradle")
    try {
        if (settings != null) {
            settings.gradle.gradleUserHomeDir = fallback
        }
        setGradleUserHome(fallback)
        println "✅ Init.gradle (${context}): Using fallback: ${fallback.absolutePath}"
        return true
    } catch (Exception e) {
        println "⚠️  Init.gradle (${context}): Fallback failed: ${e.message}"
        return false
    }
}

// ============================================================================
// INITIALIZATION
// ============================================================================

// Get and validate user home
def userHome = getUserHome()
def gradleUserHome = new File(userHome, ".gradle")

// Force system properties BEFORE anything else (critical for early initialization)
if (userHome != null && !userHome.isEmpty() && !userHome.startsWith("/Volumes/")) {
    System.setProperty("user.home", userHome)
    setGradleUserHome(gradleUserHome)
    println "✅ Init.gradle: System properties set - user.home=${userHome}, gradle.user.home=${gradleUserHome.absolutePath}"
} else {
    // Even if on volume, try to set a fallback
    def fallbackHome = getFallbackHome()
    def fallbackGradleHome = new File(fallbackHome, ".gradle")
    System.setProperty("user.home", fallbackHome)
    setGradleUserHome(fallbackGradleHome)
    println "⚠️  Init.gradle: Using fallback - user.home=${fallbackHome}, gradle.user.home=${fallbackGradleHome.absolutePath}"
}

// ============================================================================
// GRADLE HOOKS - Multiple levels of protection
// ============================================================================

// Force at settings level (runs first - most critical)
beforeSettings { settings ->
    def gh = new File(getUserHome(), ".gradle")
    forceGradleUserHome(settings, gh, "beforeSettings")
}

// Force at settings evaluated (runs after settings are loaded - double check)
settingsEvaluated { settings ->
    def gh = new File(getUserHome(), ".gradle")
    forceGradleUserHome(settings, gh, "settingsEvaluated")
}

// Force at project level (final check)
projectsLoaded {
    def gh = new File(getUserHome(), ".gradle")
    if (isPathSafe(gh)) {
        try {
            rootProject.ext.gradleUserHome = gh
            setGradleUserHome(gh)
            println "✅ Init.gradle (projectsLoaded): Project-level Gradle user home set to: ${gh.absolutePath}"
        } catch (Exception e) {
            println "⚠️  Init.gradle (projectsLoaded): Error: ${e.message}"
        }
    } else {
        def fallback = new File(getFallbackHome(), ".gradle")
        try {
            rootProject.ext.gradleUserHome = fallback
            setGradleUserHome(fallback)
            println "✅ Init.gradle (projectsLoaded): Using fallback: ${fallback.absolutePath}"
        } catch (Exception e) {
            println "⚠️  Init.gradle (projectsLoaded): Fallback failed: ${e.message}"
        }
    }
}

// Prevent any volume-based cache creation (proactive prevention)
gradle.beforeProject { project ->
    def currentUserHome = System.getProperty("org.gradle.user.home")
    if (currentUserHome != null && currentUserHome.startsWith("/Volumes/")) {
        def correctHome = new File(getFallbackHome(), ".gradle")
        setGradleUserHome(correctHome)
        println "✅ Init.gradle (beforeProject): Corrected volume-based path to: ${correctHome.absolutePath}"
    }
}
